<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SENTENCE SLOT ‚Äî REFLEX VOCAB</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Orbitron:wght@500;700;900&display=swap');

        :root {
            --color-bg: #0a0a0a;
            --color-gold: #FFD700;
            --color-gold-shine: #FFF8DC;
            --color-neon-red: #FF0033;
            --color-panel: rgba(20, 20, 20, 0.9);
            --font-main: 'Inter', sans-serif;
            --font-digit: 'Orbitron', sans-serif;
        }

        body {
            background-color: var(--color-bg);
            background-image: radial-gradient(circle at 50% 50%, #1a1a1a 0%, #000 100%);
            color: white;
            font-family: var(--font-main);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
            width: 100%;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }

        .pachinko-frame {
            border: 4px solid var(--color-gold);
            box-shadow: 0 0 10px var(--color-gold);
            border-radius: 20px;
            background: var(--color-panel);
            position: relative;
        }

        button {
            cursor: pointer;
            font-family: var(--font-main);
        }

        .btn-nav {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid var(--color-gold);
            color: var(--color-gold);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            text-decoration: none;
        }

        .container {
            width: 100%;
            max-width: 600px;
            padding: 1rem 0;
            margin: 0 auto;
        }

        .slot-machine {
            background: linear-gradient(180deg, #2a2a2a 0%, #000 100%);
            border: 8px solid var(--color-gold);
            border-radius: 30px;
            padding: 30px;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.2);
            position: relative;
        }

        .reels-container {
            display: flex;
            gap: 15px;
            background: #000;
            padding: 15px;
            border-radius: 15px;
            border: 2px solid #555;
            margin-bottom: 10px;
            overflow: hidden;
        }

        .reel-window {
            flex: 1;
            height: 180px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .reel-tape {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            transition: top 0.1s linear;
        }

        .reel-item {
            height: 180px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: black;
            border-bottom: 1px solid #eee;
        }

        .reel-item .kanji {
            font-size: 1.6rem;
            color: #d00;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .reel-item .kana {
            font-size: 0.8rem;
            color: #666;
        }

        .controls-area {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
        }

        #start-lever {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #ff4444, #990000);
            border: 4px solid var(--color-gold-shine);
            color: white;
            font-weight: 900;
        }

        .btn-stop {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #4444ff, #000099);
            border: 3px solid #aaf;
            color: white;
        }

        .btn-stop:disabled {
            opacity: 0.3;
        }

        .status-display {
            background: black;
            border: 2px solid var(--color-neon-red);
            padding: 10px;
            text-align: center;
            margin-bottom: 10px;
            border-radius: 10px;
        }

        .status-text {
            font-family: var(--font-digit);
            color: var(--color-neon-red);
        }

        @media (max-width: 600px) {
            .slot-machine {
                padding: 15px;
            }

            .reel-item .kanji {
                font-size: 1.1rem;
            }

            .reel-item .kana {
                display: none;
            }
        }

        @keyframes rainbow-border {
            0% {
                border-color: red;
                box-shadow: 0 0 10px red;
            }

            20% {
                border-color: orange;
                box-shadow: 0 0 20px orange;
            }

            40% {
                border-color: yellow;
                box-shadow: 0 0 40px yellow;
            }

            60% {
                border-color: green;
                box-shadow: 0 0 20px green;
            }

            80% {
                border-color: blue;
                box-shadow: 0 0 10px blue;
            }

            100% {
                border-color: purple;
                box-shadow: 0 0 10px purple;
            }
        }

        @keyframes rumble {

            0%,
            100% {
                transform: translate(0, 0);
            }

            25% {
                transform: translate(-2px, 2px);
            }

            50% {
                transform: translate(2px, -2px);
            }

            75% {
                transform: translate(-2px, -2px);
            }
        }

        @keyframes hinge-drop {
            0% {
                transform: rotate(0) translateY(0);
            }

            20% {
                transform: rotate(5deg) translateY(20px);
            }

            40% {
                transform: rotate(3deg) translateY(15px);
            }

            60% {
                transform: rotate(5deg) translateY(20px);
            }

            80% {
                transform: rotate(4deg) translateY(20px);
            }

            100% {
                transform: rotate(5deg) translateY(25px);
            }
        }

        .reach-active {
            animation: hinge-drop 0.8s ease-out forwards !important;
            box-shadow: 0 10px 30px rgba(255, 0, 0, 0.5);
            border-color: red !important;
        }

        .reach-background {
            background-color: rgba(255, 0, 0, 0.1) !important;
            animation: rumble 0.2s linear infinite;
            border: 2px solid red !important;
        }

        #result-meaning {
            background-color: rgba(200, 0, 0, 0.8);
            border: 2px solid #ff4b4b;
            color: #fff;
            padding: 10px 20px;
            border-radius: 12px;
            font-size: 1.1rem;
            margin-top: 15px;
            display: none;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.4);
            text-align: center;
        }
    </style>
</head>

<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; padding: 10px;">
            <a href="index.html" class="btn-nav">‚Üê LOBBY</a>
            <div id="coin-wallet"
                style="border: 2px solid var(--color-gold); padding: 5px 15px; border-radius: 20px; color: var(--color-gold);">
                üí∞ <span id="coin-count">0</span>
            </div>
        </div>

        <div class="slot-machine">
            <div class="status-display">
                <span id="status-text" class="status-text">CLICK START</span>
            </div>
            <div class="reels-container">
                <div class="reel-window">
                    <div class="reel-tape" id="reel-1"></div>
                </div>
                <div class="reel-window">
                    <div class="reel-tape" id="reel-2"></div>
                </div>
                <div class="reel-window">
                    <div class="reel-tape" id="reel-3"></div>
                </div>
            </div>
        </div>

        <div class="controls-area">
            <button class="btn-stop" id="stop-1" disabled>S1</button>
            <button class="btn-stop" id="stop-2" disabled>S2</button>
            <button class="btn-stop" id="stop-3" disabled>S3</button>
            <button id="start-lever">START</button>
        </div>
        <p id="result-meaning" style="text-align:center; color: #aaa; font-size: 1.2rem; margin-top:20px;"></p>
    </div>
    <script src="js/utils.js"></script>
    <script>

        const reelElements = [document.getElementById('reel-1'), document.getElementById('reel-2'), document.getElementById('reel-3')];
        const statusText = document.getElementById('status-text');
        const coinCountDisplay = document.getElementById('coin-count');
        const resultMeaning = document.getElementById('result-meaning');

        let userCoins = parseInt(localStorage.getItem('reflex_coins')) || 100;
        let slotData = null;
        let reels = [[], [], []];
        let spinIntervals = [null, null, null];
        let stopping = [false, false, false];
        let stopCount = 0;

        async function init() {
            const resp = await fetch('data/slots.json');
            slotData = await resp.json();

            const fails = (slotData.failEvents || []).map(f => ({ kanji: f.emoji, text: "X", meaning: "", type: 'fail' }));

            // English SVO order: Reel 0=Subject, Reel 1=Verb, Reel 2=Object
            reels[0] = [...slotData.subjects, ...fails, ...slotData.subjects];
            reels[1] = [...slotData.verbs, ...fails, ...slotData.verbs];
            const objKeys = Object.keys(slotData.objects).map(k => ({ text: k, kanji: k, meaning: slotData.objects[k].meaning }));
            reels[2] = [...objKeys, ...fails, ...objKeys];

            reels.forEach((r, i) => {
                reelElements[i].innerHTML = r.map(item => `<div class="reel-item"><div class="kanji">${item.kanji}</div><div class="kana">${item.text}</div></div>`).join('');
            });

            coinCountDisplay.textContent = userCoins;

            document.getElementById('start-lever').onclick = startSpin;
            [0, 1, 2].forEach(i => document.getElementById(`stop-${i + 1}`).onclick = () => stopReel(i));
        }


        function startSpin() {
            if (spinIntervals.some(i => i)) return;
            if (userCoins < 10) { alert("Coins needed!"); return; }
            userCoins -= 10; coinCountDisplay.textContent = userCoins; localStorage.setItem('reflex_coins', userCoins);

            stopCount = 0; stopping = [false, false, false];
            resultMeaning.textContent = "";
            resultMeaning.style.display = 'none';

            document.querySelector('.slot-machine').classList.remove('reach-active');
            document.querySelector('.container').classList.remove('reach-background');
            statusText.style.color = "var(--color-neon-red)";

            reels.forEach((_, i) => {
                let pos = 0;
                spinIntervals[i] = setInterval(() => {
                    pos -= 20; if (pos <= -180 * reels[i].length / 3) pos = 0;
                    reelElements[i].style.top = pos + "px";
                }, 20);
                document.getElementById(`stop-${i + 1}`).disabled = false;
            });
            Utils.playSound('spin');
        }

        function stopReel(i) {
            if (stopping[i] || !spinIntervals[i]) return;
            clearInterval(spinIntervals[i]);
            spinIntervals[i] = null;
            stopping[i] = true;
            stopCount++;

            const finalPos = Math.round(parseFloat(reelElements[i].style.top) / 180) * 180;
            reelElements[i].style.top = finalPos + "px";
            Utils.playSound('stop');
            document.getElementById(`stop-${i + 1}`).disabled = true;

            // SVO: Check Reach when Subject and Verb are stopped, Object remains
            if (stopCount === 2) {
                const lastReelIndex = stopping.findIndex(s => !s);
                if (lastReelIndex !== -1) {
                    clearInterval(spinIntervals[lastReelIndex]);
                    let pos = parseFloat(reelElements[lastReelIndex].style.top);
                    spinIntervals[lastReelIndex] = setInterval(() => {
                        pos -= 20; if (pos <= -180 * reels[lastReelIndex].length / 3) pos = 0;
                        reelElements[lastReelIndex].style.top = pos + "px";
                    }, 80);
                }

                // Reach: Subject(0) and Verb(1) stopped, Object(2) still spinning
                if (lastReelIndex === 2) {
                    const getSymbol = (i) => {
                        const r = reels[i];
                        const top = parseFloat(reelElements[i].style.top);
                        const idx = (Math.abs(Math.round(top / 180)) % r.length);
                        return r[idx];
                    };

                    const s1 = getSymbol(0); // Subject
                    const s2 = getSymbol(1); // Verb

                    if (s1 && s2 && s1.type !== 'fail' && s2.type !== 'fail') {
                        Utils.playSound('siren');
                        Utils.speak('REACH!');
                        statusText.innerHTML = `REACH!!<br><span style="font-size:0.6em; color:#fff;">(${s1.kanji} ${s2.kanji} ???)</span>`;
                        statusText.style.color = "var(--color-neon-red)";
                        document.querySelector('.slot-machine').classList.add('reach-active');
                        document.querySelector('.container').classList.add('reach-background');
                    }
                }
            }

            if (stopCount === 3) finishSpin();
        }

        function finishSpin() {
            const results = reels.map((r, i) => {
                const idx = Math.abs(Math.round(parseFloat(reelElements[i].style.top) / 180));
                return r[idx];
            });

            // SVO order: results[0]=Subject, results[1]=Verb, results[2]=Object
            const subject = results[0].kanji;
            const verb = results[1].kanji;
            const obj = results[2].kanji;
            const sentence = `${subject} ${verb} ${obj}`;
            const meaning = `${results[0].meaning} ${results[1].meaning} ${results[2].meaning}`;

            // Check Win: does the object accept this verb?
            const objKey = results[2].text;
            const verbText = results[1].kanji;
            const validVerbs = slotData.objects[objKey] ? slotData.objects[objKey].verbs : [];
            const isWin = validVerbs.includes(verbText);

            resultMeaning.textContent = meaning + (isWin ? " ‚úÖ Great!" : " ‚ùå Hmm...");
            resultMeaning.style.display = 'block';

            Utils.speak(sentence);

            document.querySelector('.slot-machine').classList.remove('reach-active');
            document.querySelector('.container').classList.remove('reach-background');

            if (isWin) {
                userCoins += 50;
                coinCountDisplay.textContent = userCoins;
                localStorage.setItem('reflex_coins', userCoins);
                Utils.playSound('win');
                statusText.textContent = "WIN! +50";
                statusText.style.color = "#4bff4b";
            } else {
                statusText.textContent = "TRY AGAIN";
                statusText.style.color = "#ff4b4b";
            }
        }

        init();
    </script>
</body>

</html>